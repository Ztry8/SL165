<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
  <title>SL165 - Olymp</title>
  <link rel="stylesheet" href="add.css">
  <link rel="icon" href="logo.png" type="image/png">
</meta>
</head>
<body>

<header>
  <a href="index.html" class="logo"><img src="logo.png" alt="Logo"></a>
  <nav>
    <a href="index.html">Главная</a>
    <a href="delete.html">Удалить Диплом</a>
  </nav>
</header>

<div class="container">
  <div class="main-content" style="flex:1;">
    <h1>Добавление Диплома</h1>
    <input id="namePerson" placeholder="Имя">
    <input id="year" placeholder="Год победы">
    <input id="classNum" placeholder="Класс">
    <input id="title" placeholder="Название и предмет">
    <select id="stage">
      <option value="Школьный">Школьный</option>
      <option value="Городской">Городской</option>
      <option value="Республиканский">Республиканский</option>
      <option value="Международный">Международный</option>
    </select>
    <input type="file" id="photoFiles" multiple>
    <input id="pass" type="password" placeholder="Пароль">
    <button onclick="add()">Добавить</button>

    <div id="message" class="message"></div>
  </div>
</div>

<script>
async function add() {
  const files = Array.from(document.getElementById('photoFiles').files);
  const photos = [];
  for (const file of files) {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    await new Promise(resolve => {
      reader.onload = () => { photos.push(reader.result); resolve(); };
    });
  }

  const body = {
    namePerson: document.getElementById('namePerson').value,
    birth_year: parseInt(document.getElementById('year').value),
    classNum: parseInt(document.getElementById('classNum').value),
    title: document.getElementById('title').value,
    stage: document.getElementById('stage').value,
    photos: photos,
    password: document.getElementById('pass').value
  };

  const res = await fetch('/.netlify/functions/people', {
    method: 'POST',
    body: JSON.stringify(body)
  });

  const msgDiv = document.getElementById('message');

  function redirectWithDelay() {
    setTimeout(() => {
      window.location.href = "index.html"; 
    }, 3000);
  }

  if (res.ok) {
    msgDiv.textContent = "Успешно добавлено!";
    msgDiv.className = "message success show";

    document.getElementById('namePerson').value = ''; 
    document.getElementById('year').value = ''; 
    document.getElementById('classNum').value = ''; 
    document.getElementById('title').value = ''; 
    document.getElementById('stage').value = 'Городской'; 
    document.getElementById('photoFiles').value = ''; 
    document.getElementById('pass').value = '';

    redirectWithDelay();
  } else {
    const text = await res.text();
    msgDiv.textContent = "Ошибка: " + text;
    msgDiv.className = "message error show";
  }
}
</script>

</body>
</html>